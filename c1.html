<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cement Plant - Industrial IoT Platform</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --radius: 0.75rem;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
        }

        /* Main Content */
        .main-content {
            padding: 24px;
            min-height: 100vh;
        }

        .header {
            background: white;
            padding: 20px 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .connection-status-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--gray-50);
            border-radius: var(--radius);
            border: 1px solid var(--gray-200);
            font-size: 13px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger);
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--success);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: var(--success);
            color: white;
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-ghost {
            background: white;
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
            padding: 8px 16px;
            font-size: 13px;
        }

        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            gap: 24px;
            grid-template-columns: repeat(12, 1fr);
        }

        .col-span-12 { grid-column: span 12; }
        .col-span-8 { grid-column: span 8; }
        .col-span-6 { grid-column: span 6; }
        .col-span-4 { grid-column: span 4; }
        .col-span-3 { grid-column: span 3; }

        /* Card */
        .card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            overflow: hidden;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--primary);
        }

        .card-body {
            padding: 24px;
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-info {
            background: #cffafe;
            color: #0e7490;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px;
            border-radius: var(--radius);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .stat-card.frozen {
            opacity: 0.85;
            border: 2px solid var(--warning);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20px;
            width: 100px;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(15deg);
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            line-height: 1;
        }

        .stat-unit {
            font-size: 14px;
            opacity: 0.8;
            margin-left: 4px;
        }

        .stat-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 36px;
            opacity: 0.2;
        }

        .freeze-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--warning);
            color: var(--gray-900);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            display: none;
        }

        .stat-card.frozen .freeze-indicator {
            display: block;
        }

        /* Control Panel */
        .control-panel {
            display: grid;
            gap: 12px;
        }

        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--gray-50);
            border-radius: var(--radius);
            border: 1px solid var(--gray-200);
            transition: all 0.2s;
        }

        .control-row:hover {
            border-color: var(--gray-300);
            box-shadow: var(--shadow-sm);
        }

        .control-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid var(--gray-200);
        }

        .control-icon i {
            font-size: 18px;
            color: var(--gray-600);
        }

        .control-icon.active i {
            color: var(--success);
        }

        .control-label {
            font-weight: 500;
            color: var(--gray-900);
            font-size: 14px;
        }

        .control-actions {
            display: flex;
            gap: 8px;
        }

        /* JSON Viewer */
        .json-viewer {
            background: var(--gray-900);
            color: #10b981;
            padding: 20px;
            border-radius: var(--radius);
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.8;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        .json-key {
            color: #60a5fa;
        }

        .json-string {
            color: #34d399;
        }

        .json-number {
            color: #fbbf24;
        }

        .json-boolean {
            color: #f472b6;
        }

        /* Target Input */
        .target-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .input-field {
            padding: 10px 14px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 14px;
            transition: all 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Timestamp */
        .timestamp {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--gray-500);
            padding: 12px 16px;
            background: var(--gray-50);
            border-radius: var(--radius);
            margin-top: 16px;
        }

        /* Section Divider */
        .section-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 24px 0;
            color: var(--gray-500);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section-divider::before,
        .section-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--gray-200);
        }

        /* W5 Control Box */
        .w5-control-box {
            background: var(--gray-50);
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 20px;
        }

        .w5-control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .w5-control-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .w5-control-actions {
            display: flex;
            gap: 8px;
        }

        .w5-info {
            font-size: 12px;
            color: var(--gray-600);
            line-height: 1.5;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .col-span-8,
            .col-span-6,
            .col-span-4,
            .col-span-3 {
                grid-column: span 12;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-400);
        }

        .device-tag {
            display: inline-block;
            padding: 2px 8px;
            background: var(--gray-200);
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            color: var(--gray-600);
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>Cement Plant Monitor</h1>
                <div style="font-size: 14px; color: var(--gray-500); margin-top: 4px;">Real-time IoT monitoring and control</div>
            </div>
            <div class="header-actions">
                <div class="connection-status-header">
                    <div class="status-dot" id="connectionDot"></div>
                    <span id="connectionText" style="font-weight: 500;">Connecting...</span>
                    <span style="color: var(--gray-400);">|</span>
                    <span style="font-size: 11px; color: var(--gray-500);">HiveMQ Cloud</span>
                </div>
                <button class="btn btn-danger" onclick="emergencyStop()">
                    <i class="fas fa-power-off"></i>
                    Emergency Stop
                </button>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- All Sensor Readings -->
            <div class="col-span-12">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-chart-line"></i>
                            Live Sensor Data
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid">
                            <!-- Load Cell Weights -->
                            <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                                <div class="stat-label">Weight 1 <span class="device-tag">ESP1</span></div>
                                <div class="stat-value" id="w1">--</div>
                                <div class="stat-unit">kg</div>
                                <i class="fas fa-balance-scale stat-icon"></i>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                                <div class="stat-label">Weight 2 <span class="device-tag">ESP1</span></div>
                                <div class="stat-value" id="w2">--</div>
                                <div class="stat-unit">kg</div>
                                <i class="fas fa-balance-scale stat-icon"></i>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);">
                                <div class="stat-label">Weight 3 <span class="device-tag">ESP1</span></div>
                                <div class="stat-value" id="w3">--</div>
                                <div class="stat-unit">kg</div>
                                <i class="fas fa-balance-scale stat-icon"></i>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                <div class="stat-label">Weight 4 <span class="device-tag">ESP1</span></div>
                                <div class="stat-value" id="w4">--</div>
                                <div class="stat-unit">kg</div>
                                <i class="fas fa-balance-scale stat-icon"></i>
                            </div>
                            <div class="stat-card" id="w5Card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                <div class="freeze-indicator"><i class="fas fa-snowflake"></i> FROZEN</div>
                                <div class="stat-label">Weight 5 <span class="device-tag">ESP1</span></div>
                                <div class="stat-value" id="w5">--</div>
                                <div class="stat-unit">kg</div>
                                <i class="fas fa-balance-scale stat-icon"></i>
                            </div>

                            <!-- Environmental Sensors - Kiln -->
                            <div class="stat-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                                <div class="stat-label">Kiln Temp <span class="device-tag">ESP2</span></div>
                                <div class="stat-value" id="kilnTemp">--</div>
                                <div class="stat-unit">¬∞C</div>
                                <i class="fas fa-thermometer-three-quarters stat-icon"></i>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
                                <div class="stat-label">Kiln Humidity <span class="device-tag">ESP2</span></div>
                                <div class="stat-value" id="kilnHumidity">--</div>
                                <div class="stat-unit">%</div>
                                <i class="fas fa-tint stat-icon"></i>
                            </div>

                            <!-- Environmental Sensors - Preheating Tower -->
                            <div class="stat-card" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);">
                                <div class="stat-label">Preheating Tower Temp <span class="device-tag">ESP2</span></div>
                                <div class="stat-value" id="preheatingTemp">--</div>
                                <div class="stat-unit">¬∞C</div>
                                <i class="fas fa-tower-broadcast stat-icon"></i>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);">
                                <div class="stat-label">Preheating Tower Humidity <span class="device-tag">ESP2</span></div>
                                <div class="stat-value" id="preheatingHumidity">--</div>
                                <div class="stat-unit">%</div>
                                <i class="fas fa-droplet stat-icon"></i>
                            </div>

                            <!-- Other Sensors -->
                            <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                <div class="stat-label">Pulley Temp <span class="device-tag">ESP2</span></div>
                                <div class="stat-value" id="pulleyTemp">--</div>
                                <div class="stat-unit">¬∞C</div>
                                <i class="fas fa-temperature-high stat-icon"></i>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                                <div class="stat-label">Vibration <span class="device-tag">ESP2</span></div>
                                <div class="stat-value" id="vibration">--</div>
                                <div class="stat-unit">/ 8</div>
                                <i class="fas fa-wave-square stat-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weight Targets Section -->
            <div class="col-span-12">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-bullseye"></i>
                            Weight Targets Configuration
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="target-grid">
                            <div class="input-group">
                                <label class="input-label">Target 1 (kg) <span class="device-tag">ESP1</span></label>
                                <input type="number" class="input-field" id="target1" placeholder="Enter weight" min="0">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Target 2 (kg) <span class="device-tag">ESP1</span></label>
                                <input type="number" class="input-field" id="target2" placeholder="Enter weight" min="0">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Target 3 (kg) <span class="device-tag">ESP1</span></label>
                                <input type="number" class="input-field" id="target3" placeholder="Enter weight" min="0">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Target 4 (kg) <span class="device-tag">ESP1</span></label>
                                <input type="number" class="input-field" id="target4" placeholder="Enter weight" min="0">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="setTargets()">
                            <i class="fas fa-paper-plane"></i>
                            Apply Weight Targets
                        </button>

                        <!-- W5 Freeze Control -->
                        <div class="w5-control-box">
                            <div class="w5-control-header">
                                <div class="w5-control-title">
                                    <i class="fas fa-snowflake"></i>
                                    Weight 5 Display Control
                                    <span class="badge" id="w5StatusBadge">LIVE</span>
                                </div>
                                <div class="w5-control-actions">
                                    <button class="btn btn-warning" onclick="freezeW5()">
                                        <i class="fas fa-pause"></i> Freeze
                                    </button>
                                    <button class="btn btn-success" onclick="unfreezeW5()">
                                        <i class="fas fa-play"></i> Unfreeze
                                    </button>
                                </div>
                            </div>
                            <div class="w5-info">
                                <i class="fas fa-info-circle"></i> 
                                Use <strong>Freeze</strong> to lock the current Weight 5 reading for reference. 
                                Use <strong>Unfreeze</strong> to resume real-time updates.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Control Systems -->
            <div class="col-span-8">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-sliders-h"></i>
                            Actuator Control Panel
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Kiln Controls -->
                        <div class="section-divider">
                            <span><i class="fas fa-fire"></i> Kiln System</span>
                        </div>
                        <div class="control-panel">
                            <div class="control-row">
                                <div class="control-info">
                                    <div class="control-icon" id="icon-blower">
                                        <i class="fas fa-fan"></i>
                                    </div>
                                    <div>
                                        <div class="control-label">Kiln Blower <span class="device-tag">ESP2</span></div>
                                        <span class="badge" id="badge-blower">OFF</span>
                                    </div>
                                </div>
                                <div class="control-actions">
                                    <button class="btn btn-success" onclick="controlRelay('blower', true)">
                                        <i class="fas fa-power-off"></i> ON
                                    </button>
                                    <button class="btn btn-ghost" onclick="controlRelay('blower', false)">
                                        <i class="fas fa-power-off"></i> OFF
                                    </button>
                                </div>
                            </div>

                            <div class="control-row">
                                <div class="control-info">
                                    <div class="control-icon" id="icon-heater">
                                        <i class="fas fa-fire"></i>
                                    </div>
                                    <div>
                                        <div class="control-label">Kiln Heater <span class="device-tag">ESP2</span></div>
                                        <span class="badge" id="badge-heater">OFF</span>
                                    </div>
                                </div>
                                <div class="control-actions">
                                    <button class="btn btn-success" onclick="controlRelay('heater', true)">
                                        <i class="fas fa-power-off"></i> ON
                                    </button>
                                    <button class="btn btn-ghost" onclick="controlRelay('heater', false)">
                                        <i class="fas fa-power-off"></i> OFF
                                    </button>
                                </div>
                            </div>

                            <div class="control-row">
                                <div class="control-info">
                                    <div class="control-icon" id="icon-motor">
                                        <i class="fas fa-cog"></i>
                                    </div>
                                    <div>
                                        <div class="control-label">Motor <span class="device-tag">ESP2</span></div>
                                        <span class="badge" id="badge-motor">OFF</span>
                                    </div>
                                </div>
                                <div class="control-actions">
                                    <button class="btn btn-success" onclick="controlRelay('motor', true)">
                                        <i class="fas fa-power-off"></i> ON
                                    </button>
                                    <button class="btn btn-ghost" onclick="controlRelay('motor', false)">
                                        <i class="fas fa-power-off"></i> OFF
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Pulley System -->
                        <div class="section-divider">
                            <span><i class="fas fa-cogs"></i> Pulley System</span>
                        </div>
                        <div class="control-panel">
                            <div class="control-row">
                                <div class="control-info">
                                    <div class="control-icon" id="icon-pulley1">
                                        <i class="fas fa-circle-notch"></i>
                                    </div>
                                    <div>
                                        <div class="control-label">Pulley 1 <span class="device-tag">ESP2</span></div>
                                        <span class="badge" id="badge-pulley1">OFF</span>
                                    </div>
                                </div>
                                <div class="control-actions">
                                    <button class="btn btn-success" onclick="controlRelay('pulley1', true)">
                                        <i class="fas fa-power-off"></i> ON
                                    </button>
                                    <button class="btn btn-ghost" onclick="controlRelay('pulley1', false)">
                                        <i class="fas fa-power-off"></i> OFF
                                    </button>
                                </div>
                            </div>

                            <div class="control-row">
                                <div class="control-info">
                                    <div class="control-icon" id="icon-pulley2">
                                        <i class="fas fa-circle-notch"></i>
                                    </div>
                                    <div>
                                        <div class="control-label">Pulley 2 <span class="device-tag">ESP2</span></div>
                                        <span class="badge" id="badge-pulley2">OFF</span>
                                    </div>
                                </div>
                                <div class="control-actions">
                                    <button class="btn btn-success" onclick="controlRelay('pulley2', true)">
                                        <i class="fas fa-power-off"></i> ON
                                    </button>
                                    <button class="btn btn-ghost" onclick="controlRelay('pulley2', false)">
                                        <i class="fas fa-power-off"></i> OFF
                                    </button>
                                </div>
                            </div>

                            <div class="control-row">
                                <div class="control-info">
                                    <div class="control-icon" id="icon-pulley3">
                                        <i class="fas fa-circle-notch"></i>
                                    </div>
                                    <div>
                                        <div class="control-label">Pulley 3 <span class="device-tag">ESP2</span></div>
                                        <span class="badge" id="badge-pulley3">OFF</span>
                                    </div>
                                </div>
                                <div class="control-actions">
                                    <button class="btn btn-success" onclick="controlRelay('pulley3', true)">
                                        <i class="fas fa-power-off"></i> ON
                                    </button>
                                    <button class="btn btn-ghost" onclick="controlRelay('pulley3', false)">
                                        <i class="fas fa-power-off"></i> OFF
                                    </button>
                                </div>
                            </div>

                            <div class="control-row">
                                <div class="control-info">
                                    <div class="control-icon" id="icon-rotor">
                                        <i class="fas fa-sync"></i>
                                    </div>
                                    <div>
                                        <div class="control-label">Rotor <span class="device-tag">ESP2</span></div>
                                        <span class="badge" id="badge-rotor">OFF</span>
                                    </div>
                                </div>
                                <div class="control-actions">
                                    <button class="btn btn-success" onclick="controlRelay('rotor', true)">
                                        <i class="fas fa-power-off"></i> ON
                                    </button>
                                    <button class="btn btn-ghost" onclick="controlRelay('rotor', false)">
                                        <i class="fas fa-power-off"></i> OFF
                                    </button>
                                </div>
                            </div>

                            <div class="control-row">
                                <div class="control-info">
                                    <div class="control-icon" id="icon-pulley_heater">
                                        <i class="fas fa-fire-alt"></i>
                                    </div>
                                    <div>
                                        <div class="control-label">Pulley Heater <span class="device-tag">ESP2</span></div>
                                        <span class="badge" id="badge-pulley_heater">OFF</span>
                                    </div>
                                </div>
                                <div class="control-actions">
                                    <button class="btn btn-success" onclick="controlRelay('pulley_heater', true)">
                                        <i class="fas fa-power-off"></i> ON
                                    </button>
                                    <button class="btn btn-ghost" onclick="controlRelay('pulley_heater', false)">
                                        <i class="fas fa-power-off"></i> OFF
                                    </button>
                                </div>
                            </div>

                            <div class="control-row">
                                <div class="control-info">
                                    <div class="control-icon" id="icon-pulley_blower">
                                        <i class="fas fa-wind"></i>
                                    </div>
                                    <div>
                                        <div class="control-label">Pulley Blower <span class="device-tag">ESP2</span></div>
                                        <span class="badge" id="badge-pulley_blower">OFF</span>
                                    </div>
                                </div>
                                <div class="control-actions">
                                    <button class="btn btn-success" onclick="controlRelay('pulley_blower', true)">
                                        <i class="fas fa-power-off"></i> ON
                                    </button>
                                    <button class="btn btn-ghost" onclick="controlRelay('pulley_blower', false)">
                                        <i class="fas fa-power-off"></i> OFF
                                    </button>
                                </div>
                            </div>

                            <div class="control-row">
                                <div class="control-info">
                                    <div class="control-icon" id="icon-pulley_vibration_motor">
                                        <i class="fas fa-wifi"></i>
                                    </div>
                                    <div>
                                        <div class="control-label">Vibration Motor <span class="device-tag">ESP2</span></div>
                                        <span class="badge" id="badge-pulley_vibration_motor">OFF</span>
                                    </div>
                                </div>
                                <div class="control-actions">
                                    <button class="btn btn-success" onclick="controlRelay('pulley_vibration_motor', true)">
                                        <i class="fas fa-power-off"></i> ON
                                    </button>
                                    <button class="btn btn-ghost" onclick="controlRelay('pulley_vibration_motor', false)">
                                        <i class="fas fa-power-off"></i> OFF
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Raw JSON Data -->
            <div class="col-span-4">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-code"></i>
                            Raw MQTT Data
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div style="padding: 16px; border-bottom: 1px solid var(--gray-200); background: var(--gray-50);">
                            <div style="font-size: 12px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">
                                <i class="fas fa-weight"></i> ESP1 - Load Cells
                            </div>
                            <div style="font-size: 11px; color: var(--gray-500);">
                                Topic: rmg/iot/sensor/es1
                            </div>
                            <div class="timestamp" style="margin-top: 8px; padding: 8px;">
                                <i class="far fa-clock"></i>
                                <span id="esp1Timestamp">Waiting...</span>
                            </div>
                        </div>
                        <pre class="json-viewer" id="esp1Json">Waiting for data...</pre>
                        
                        <div style="padding: 16px; border-bottom: 1px solid var(--gray-200); background: var(--gray-50); border-top: 2px solid var(--gray-300);">
                            <div style="font-size: 12px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">
                                <i class="fas fa-temperature-high"></i> ESP2 - Kiln System
                            </div>
                            <div style="font-size: 11px; color: var(--gray-500);">
                                Topic: rmg/iot/sensor/es2
                            </div>
                            <div class="timestamp" style="margin-top: 8px; padding: 8px;">
                                <i class="far fa-clock"></i>
                                <span id="esp2Timestamp">Waiting...</span>
                            </div>
                        </div>
                        <pre class="json-viewer" id="esp2Json">Waiting for data...</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // MQTT Configuration
        const brokerUrl = 'wss://6fdddaf19d614da29c86428142cbe7a2.s1.eu.hivemq.cloud:8884/mqtt';
        const options = {
            username: 'ruthvik',
            password: 'Iotiq369.',
            clientId: 'WebDashboard_' + Math.random().toString(16).substr(2, 8)
        };

        let client;
        let w5IsFrozen = false;

        // Connect to MQTT
        function connectMQTT() {
            client = mqtt.connect(brokerUrl, options);

            client.on('connect', () => {
                console.log('Connected to HiveMQ');
                document.getElementById('connectionDot').classList.add('connected');
                document.getElementById('connectionText').textContent = 'Connected';

                client.subscribe('rmg/iot/sensor/es1');
                client.subscribe('rmg/iot/sensor/es2');
            });

            client.on('message', (topic, message) => {
                const data = JSON.parse(message.toString());
                
                if (topic === 'rmg/iot/sensor/es1') {
                    updateESP1(data);
                } else if (topic === 'rmg/iot/sensor/es2') {
                    updateESP2(data);
                }
            });

            client.on('error', (error) => {
                console.error('MQTT Error:', error);
                document.getElementById('connectionText').textContent = 'Error';
            });

            client.on('offline', () => {
                document.getElementById('connectionDot').classList.remove('connected');
                document.getElementById('connectionText').textContent = 'Offline';
            });
        }

        // Pretty print JSON
        function syntaxHighlight(json) {
            if (typeof json != 'string') {
                json = JSON.stringify(json, null, 2);
            }
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        // Update ESP1
        function updateESP1(data) {
            document.getElementById('w1').textContent = data.w1 ?? '--';
            document.getElementById('w2').textContent = data.w2 ?? '--';
            document.getElementById('w3').textContent = data.w3 ?? '--';
            document.getElementById('w4').textContent = data.w4 ?? '--';
            document.getElementById('w5').textContent = data.w5 ?? '--';
            
            document.getElementById('esp1Json').innerHTML = syntaxHighlight(data);
            document.getElementById('esp1Timestamp').textContent = new Date().toLocaleTimeString();
        }

        // Update ESP2
        function updateESP2(data) {
            const kilnTemp = data['kiln temperature'] ?? '--';
            const kilnHumidity = data['kiln humidity'] ?? '--';
            
            document.getElementById('kilnTemp').textContent = kilnTemp;
            document.getElementById('kilnHumidity').textContent = kilnHumidity;
            
            document.getElementById('preheatingTemp').textContent = kilnTemp;
            document.getElementById('preheatingHumidity').textContent = kilnHumidity;
            
            document.getElementById('pulleyTemp').textContent = data.pulley_temperature ?? '--';
            document.getElementById('vibration').textContent = data.vibration_level ?? '--';

            const actuators = ['blower', 'heater', 'motor', 'pulley1', 'pulley2', 'pulley3', 'rotor', 
                             'pulley_heater', 'pulley_blower', 'pulley_vibration_motor'];
            
            actuators.forEach(name => {
                let status = data[name] || data['kiln ' + name];
                updateActuatorUI(name, status);
            });

            document.getElementById('esp2Json').innerHTML = syntaxHighlight(data);
            document.getElementById('esp2Timestamp').textContent = new Date().toLocaleTimeString();
        }

        // Update actuator UI
        function updateActuatorUI(name, status) {
            const icon = document.getElementById('icon-' + name);
            const badge = document.getElementById('badge-' + name);
            
            if (icon && badge) {
                if (status) {
                    icon.classList.add('active');
                    badge.className = 'badge badge-success';
                    badge.innerHTML = '<i class="fas fa-check-circle"></i> ON';
                } else {
                    icon.classList.remove('active');
                    badge.className = 'badge badge-danger';
                    badge.innerHTML = '<i class="fas fa-times-circle"></i> OFF';
                }
            }
        }

        // Set targets
        function setTargets() {
            const target1 = parseInt(document.getElementById('target1').value) || -1;
            const target2 = parseInt(document.getElementById('target2').value) || -1;
            const target3 = parseInt(document.getElementById('target3').value) || -1;
            const target4 = parseInt(document.getElementById('target4').value) || -1;

            const payload = { target1, target2, target3, target4 };
            client.publish('rmg/iot/command/es1', JSON.stringify(payload));
            
            alert('‚úì Weight targets applied successfully!');
        }

        // Freeze W5
        function freezeW5() {
            const payload = { target5: 1 };
            client.publish('rmg/iot/command/es1', JSON.stringify(payload));
            
            w5IsFrozen = true;
            updateW5UI();
            
            alert('‚ùÑÔ∏è Weight 5 frozen at current value!');
        }

        // Unfreeze W5
        function unfreezeW5() {
            const payload = { target5: 0 };
            client.publish('rmg/iot/command/es1', JSON.stringify(payload));
            
            w5IsFrozen = false;
            updateW5UI();
            
            alert('‚ñ∂Ô∏è Weight 5 unfrozen - showing live data!');
        }

        // Update W5 UI
        function updateW5UI() {
            const w5Card = document.getElementById('w5Card');
            const w5Badge = document.getElementById('w5StatusBadge');
            
            if (w5IsFrozen) {
                w5Card.classList.add('frozen');
                w5Badge.className = 'badge badge-warning';
                w5Badge.innerHTML = '<i class="fas fa-snowflake"></i> FROZEN';
            } else {
                w5Card.classList.remove('frozen');
                w5Badge.className = 'badge badge-info';
                w5Badge.innerHTML = '<i class="fas fa-broadcast-tower"></i> LIVE';
            }
        }

        // Control relay
        function controlRelay(method, state) {
            const payload = { method, params: state };
            client.publish('rmg/iot/command/es2', JSON.stringify(payload));
            console.log(`Command sent: ${method} = ${state}`);
        }

        // Emergency stop
        function emergencyStop() {
            if (confirm('‚ö†Ô∏è WARNING: This will stop ALL actuators immediately. Continue?')) {
                const payload = { method: 'all_off', params: true };
                client.publish('rmg/iot/command/es2', JSON.stringify(payload));
                alert('üö® Emergency stop activated!');
            }
        }

        // Initialize
        connectMQTT();
    </script>
</body>
</html>
